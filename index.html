<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VINCLE ‚Äî Conversaci√≥n sin nombres</title>
  <style>
    :root{
      --bg:#0f1720;
      --card:#0b1220;
      --accent:#60a5fa;
      --muted:#94a3b8;
      --bubble:#111827;
      --glass: rgba(255,255,255,0.03);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#071028 0%, #081126 60%);display:flex;align-items:center;justify-content:center;padding:18px;}
    .app{width:100%;max-width:900px;height:90vh;background:var(--card);border-radius:14px;display:grid;grid-template-columns:320px 1fr;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    /* left panel */
    .panel{padding:18px;color:#e6eef8;border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 6px 18px rgba(6,12,30,0.6)}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .room-box{background:var(--glass);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
    input.room-input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn{padding:10px;border-radius:8px;border:none;background:var(--accent);color:#042;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px}
    .actions{display:flex;gap:8px}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}

    /* chat area */
    .chat{display:flex;flex-direction:column;height:100%}
    .chat-header{padding:16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
    .room-title{font-weight:600}
    .chat-body{flex:1;padding:14px;overflow:auto;background:
      linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:70%;padding:10px 12px;border-radius:12px;background:var(--bubble);color:#e6eef8;line-height:1.3;word-break:break-word}
    .bubble.left{align-self:flex-start;border-bottom-left-radius:4px}
    .bubble.right{align-self:flex-end;border-bottom-right-radius:4px;background:linear-gradient(135deg,var(--accent),#7dd3fc);color:#021}

    .composer{padding:12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center}
    .composer input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .meta-note{font-size:12px;color:var(--muted);padding:0 14px 10px}
    .info-line{display:flex;gap:8px;align-items:center;font-size:13px}
    .color-pill{width:12px;height:12px;border-radius:50%;display:inline-block}

    /* mobile tweak */
    @media (max-width:800px){
      .app{grid-template-columns:1fr;height:96vh}
      .panel{display:none}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="VINCLE chat an√≥nimo">
    <aside class="panel" aria-hidden="false">
      <div class="brand">
        <div class="logo">V</div>
        <div>
          <h1>VINCLE</h1>
          <div class="muted small">Habla sin nombre. Escucha sin juicio.</div>
        </div>
      </div>

      <div class="room-box" style="margin-top:6px">
        <label class="small muted">ID de sala (URL)</label>
        <input id="roomInput" class="room-input" placeholder="Escribe un id corto o deja vac√≠o para uno aleatorio" />
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="createBtn" class="btn">Crear sala</button>
          <button id="copyBtn" class="btn ghost">Copiar link</button>
        </div>
        <div class="meta">Comparte el enlace con quien quieras. Nadie necesita registrarse.</div>
      </div>

      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <div class="small muted">Tu identidad ef√≠mera</div>
        <div class="info-line">
          <span id="myEmoji">üî∑</span>
          <span id="myColor" class="color-pill"></span>
          <div style="flex:1">
            <div id="anonLabel" style="font-weight:600">Anonimo</div>
            <div class="muted small">Tu color y emoji cambian cada sesi√≥n</div>
          </div>
        </div>
      </div>

      <div style="margin-top:auto">
        <div class="small muted">Opciones (MVP)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="clearLocal" class="btn ghost">Limpiar chat local</button>
          <button id="newRoomShort" class="btn ghost">Ir a sala aleatoria</button>
        </div>
        <div class="meta small" style="margin-top:10px">
          Prototipo: reemplaza la configuraci√≥n Firebase en el c√≥digo. Reglas de DB en modo test para probar r√°pido.
        </div>
      </div>
    </aside>

    <main class="chat" aria-live="polite">
      <div class="chat-header">
        <div>
          <div class="room-title" id="roomTitle">Sala ‚Äî (cargando...)</div>
          <div class="muted small" id="roomIdText">ID: ‚Äî</div>
        </div>
        <div class="muted small">Mensajes expiraci√≥n: <span id="expiryLabel">24h</span></div>
      </div>

      <div class="chat-body" id="messages" role="log" aria-live="polite"></div>

      <div class="meta-note muted small">Los mensajes se borran localmente tras expirar (24 horas por defecto). En producci√≥n, configura reglas y pol√≠ticas de retenci√≥n en tu servidor/DB.</div>

      <div class="composer" role="region" aria-label="Componer mensaje">
        <input id="textInput" placeholder="Escribe algo... (Enter para enviar)" autocomplete="off" />
        <button id="sendBtn" class="btn">Enviar</button>
      </div>
    </main>
  </div>

  <!-- Firebase SDK (v8 namespaced, simple de integrar) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    /************************************************************************
     * CONFIGURACI√ìN: pega aqu√≠ tu Firebase config (project credentials)
     * Ejemplo: 
     * const firebaseConfig = {
     *   apiKey: "ABC..",
     *   authDomain: "tu-proyecto.firebaseapp.com",
     *   databaseURL: "https://tu-proyecto-default-rtdb.firebaseio.com",
     *   projectId: "tu-proyecto",
     *   storageBucket: "...",
     *   messagingSenderId: "...",
     *   appId: "1:..."
     * };
     ************************************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyXMvncuf1Jhux5dVzDJ_VQe3cw3tIntt",
  authDomain: "vincle-e76dd.firebaseapp.com",
  databaseURL: "https://vincle-e76dd-default-rtdb.firebaseio.com",
  projectId: "vincle-e76dd",
  storageBucket: "vincle-e76dd.firebasestorage.app",
  messagingSenderId: "11807936515",
  appId: "1:11807936515:web:ff67d9da38e956ff62cee6",
  measurementId: "G-RB84HMERL8"
};

    // Si no has puesto config, mostramos gu√≠a y evitamos errores
    if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
      console.warn("‚ö†Ô∏è Pega tu Firebase config en el archivo vincle.html (variable firebaseConfig).");
    }

    // inicializar firebase (si hay config)
    try {
      if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
        firebase.initializeApp(firebaseConfig);
      }
    } catch(e){ console.error(e) }

    // --- PAR√ÅMETROS del prototipo ---
    const MESSAGE_EXPIRY_HOURS = 24; // por defecto: 24 horas
    const ROOM_PARAM = new URLSearchParams(location.search).get('room');
    const DEFAULT_ROOM = ROOM_PARAM || localStorage.getItem('vincle_room') || null;

    // UI refs
    const roomInput = document.getElementById('roomInput');
    const createBtn = document.getElementById('createBtn');
    const copyBtn = document.getElementById('copyBtn');
    const messagesEl = document.getElementById('messages');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const roomTitle = document.getElementById('roomTitle');
    const roomIdText = document.getElementById('roomIdText');
    const myColorEl = document.getElementById('myColor');
    const myEmojiEl = document.getElementById('myEmoji');
    const anonLabel = document.getElementById('anonLabel');
    const newRoomShort = document.getElementById('newRoomShort');
    const clearLocal = document.getElementById('clearLocal');
    const expiryLabel = document.getElementById('expiryLabel');

    expiryLabel.textContent = MESSAGE_EXPIRY_HOURS + "h";

    // Palabras prohibidas b√°sicas (cliente)
    const BAD_WORDS = ["puta","cabron","idiota","imbecil","mierda","joder"]; // ejemplo simple, extiende si quieres

    // Identidad ef√≠mera: color + emoji
    const COLORS = ['#f97316','#fb7185','#60a5fa','#34d399','#f59e0b','#a78bfa','#ef4444'];
    const EMOJIS = ['üî∑','üî∂','üî∫','üîµ','üü£','üü¢','üåø','‚ú®','‚ö°','üåô','‚òÄÔ∏è','üî•'];

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // asignar identidad por sesi√≥n (no persistente servidor)
    const sessionColor = sessionStorage.getItem('vincle_color') || pick(COLORS);
    const sessionEmoji = sessionStorage.getItem('vincle_emoji') || pick(EMOJIS);
    sessionStorage.setItem('vincle_color', sessionColor);
    sessionStorage.setItem('vincle_emoji', sessionEmoji);

    myColorEl.style.background = sessionColor;
    myEmojiEl.textContent = sessionEmoji;

    // determinar sala actual
    let ROOM = DEFAULT_ROOM || null;
    function setRoom(r){
      ROOM = r;
      roomTitle.textContent = `Sala ‚Äî ${r || '(sin id)'}`;
      roomIdText.textContent = `ID: ${r || '‚Äî'}`;
      roomInput.value = r || '';
      if (r) {
        const url = location.origin + location.pathname + '?room=' + encodeURIComponent(r);
        history.replaceState(null,'', '?room=' + encodeURIComponent(r));
        localStorage.setItem('vincle_room', r);
      }
    }

    // crear id corto aleatorio
    function randomId(len=6){
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let s='';
      for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    // Construir DB referencia si firebase est√° inicializado
    function dbRefForRoom(room){
      if (!firebase || !firebase.database) return null;
      return firebase.database().ref('rooms/' + room + '/messages');
    }

    // enviar mensaje (a Firebase)
    function sendMessage(text){
      if (!text || text.trim()==='') return;
      // filtro simple
      const normalized = text.toLowerCase();
      for(const bad of BAD_WORDS){ if (normalized.includes(bad)) {
        alert('Mensaje bloqueado por lenguaje inapropiado (cliente).');
        return;
      }}
      const now = Date.now();
      const expiry = now + MESSAGE_EXPIRY_HOURS * 60 * 60 * 1000;
      const payload = {
        text: text.trim().slice(0,2000),
        color: sessionColor,
        emoji: sessionEmoji,
        ts: now,
        expiry
      };
      const db = dbRefForRoom(ROOM);
      if (!db){
        console.warn('Firebase no est√° inicializado o no hay DB. Mensaje solo local (simulaci√≥n).');
        appendLocalMessage(payload, true);
        return;
      }
      db.push(payload).catch(err=>{
        console.error('Error escribiendo en DB:', err);
        // fallback local
        appendLocalMessage(payload, true);
      });
    }

    // mostrar mensaje en UI
    function createBubble(msg, mine=false){
      const div = document.createElement('div');
      div.className = 'bubble ' + (mine ? 'right' : 'left');
      // sin nombres, solo burbuja; color de autor en borde/emoji
      const meta = document.createElement('div');
      meta.style.display='flex';
      meta.style.alignItems='center';
      meta.style.gap='8px';
      meta.style.marginBottom='6px';
      const pill = document.createElement('span');
      pill.className='color-pill';
      pill.style.background = msg.color || '#666';
      pill.style.width='10px';
      pill.style.height='10px';
      pill.style.borderRadius='50%';
      meta.appendChild(pill);
      const em = document.createElement('span');
      em.textContent = msg.emoji || 'üî∑';
      meta.appendChild(em);
      // texto
      const text = document.createElement('div');
      text.textContent = msg.text;
      // timestamp small
      const t = document.createElement('div');
      t.className='muted small';
      t.style.fontSize='11px';
      t.style.marginTop='6px';
      const d = new Date(msg.ts || Date.now());
      t.textContent = d.toLocaleString();
      div.appendChild(meta);
      div.appendChild(text);
      div.appendChild(t);
      return div;
    }

    // mostrar local-only message (simulaci√≥n)
    function appendLocalMessage(payload, mine=false){
      const bubble = createBubble(payload, mine);
      messagesEl.appendChild(bubble);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // escuchar mensajes en tiempo real
    let currentDbRef = null;
    function startListening(){
      messagesEl.innerHTML = ''; // limpiar
      const db = dbRefForRoom(ROOM);
      if (!db) {
        // no firebase -> solo simulaci√≥n local
        appendLocalMessage({text:'Prototipo sin Firebase: pega tus credenciales en el archivo para chat real.', emoji:'‚ö†Ô∏è', color:'#f59e0b', ts:Date.now()}, false);
        return;
      }
      if (currentDbRef) currentDbRef.off();
      currentDbRef = db;
      db.limitToLast(200).on('child_added', snap=>{
        const msg = snap.val();
        if (!msg) return;
        // ignorar mensajes expirados
        if (msg.expiry && Date.now() > msg.expiry) {
          return;
        }
        const mine = (msg.color === sessionColor && msg.emoji === sessionEmoji && Math.abs((msg.ts||0)-Date.now())<2000);
        const bubble = createBubble(msg, mine);
        messagesEl.appendChild(bubble);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // UI handlers
    createBtn.addEventListener('click', ()=>{
      let id = (roomInput.value || '').trim();
      if (!id) id = randomId(7);
      setRoom(id);
      startListening();
      // copy url to clipboard
      const url = location.origin + location.pathname + '?room=' + encodeURIComponent(id);
      navigator.clipboard?.writeText(url).then(()=> {
        copyBtn.textContent = 'Link copiado';
        setTimeout(()=>copyBtn.textContent='Copiar link',1500);
      }).catch(()=>{});
    });

    copyBtn.addEventListener('click', ()=>{
      if (!ROOM) {
        alert('Crea o entra a una sala primero.');
        return;
      }
      const url = location.origin + location.pathname + '?room=' + encodeURIComponent(ROOM);
      navigator.clipboard?.writeText(url).then(()=> {
        copyBtn.textContent = 'Copiado';
        setTimeout(()=>copyBtn.textContent='Copiar link',1500);
      }).catch(()=>{ alert('No se pudo copiar al portapapeles.'); });
    });

    newRoomShort.addEventListener('click', ()=>{
      const id = randomId(7);
      setRoom(id);
      startListening();
    });

    clearLocal.addEventListener('click', ()=>{
      // limpiar UI localmente
      messagesEl.innerHTML = '';
    });

    sendBtn.addEventListener('click', ()=>{
      const t = textInput.value;
      if (!t.trim()) return;
      sendMessage(t);
      textInput.value = '';
    });

    textInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // on load: si hay room param o guardada -> setear y empezar
    (function init(){
      if (!ROOM) {
        if (DEFAULT_ROOM) setRoom(DEFAULT_ROOM);
      } else setRoom(ROOM);
      if (ROOM) startListening();
      // mostrar link si existe
      if (!ROOM && ROOM_PARAM) setRoom(ROOM_PARAM);
      // poner placeholder en roomInput
      roomInput.placeholder = 'ej: cena-viernes, proyectoX, ' + randomId(4);
    })();

    // Accessibility: focus input
    textInput.focus();

    // NOTAS: En producci√≥n debes
    //  - endurecer reglas Realtime DB para permitir solo writes leg√≠timos
    //  - a√±adir moderaci√≥n server-side o checkpoints anti-abuso
    //  - configurar retenci√≥n / funci√≥n cloud para limpiar mensajes expirados
  </script>
</body>
</html>
